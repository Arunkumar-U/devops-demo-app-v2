pipeline {
    agent any

    parameters {
        string(name: 'NEW_TAG', defaultValue: '', description: 'Docker image tag to deploy')
    }

    environment {
        CONFIG_REPO = "https://github.com/Arunkumar-U/devops-demo-app-config-v2.git"
        DOCKER_IMAGE = "arunkumar1611/devops-demo-app-v2"
    }

    stages {

        stage('Clone Config Repo') {
            steps {
                git branch: 'main',
                    credentialsId: 'github',
                    url: "${CONFIG_REPO}"
            }
        }

        stage('Update Image Tag') {
            steps {
                sh """
                    sed -i 's|${DOCKER_IMAGE}:.*|${DOCKER_IMAGE}:${params.NEW_TAG}|g' k8s/deployment.yaml
                    cat k8s/deployment.yaml
                """
            }
        }

        stage('Push Config Repo') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'github',
                    usernameVariable: 'GIT_USER',
                    passwordVariable: 'GIT_PASS'
                )]) {
                    sh """
                        git config user.email "u.arunkunar1@gmail.com"
                        git config user.name "Arunkumar-U"
                        git add k8s/deployment.yaml
                        git commit -m "Update image tag to ${params.NEW_TAG}"
                        git push https://\${GIT_USER}:\${GIT_PASS}@github.com/Arunkumar-U/devops-demo-app-config-v2.git main
                    """
                }
            }
        }
    }

    post {
        success {
            echo "✅ Image tag updated to ${params.NEW_TAG} and pushed to config repo!"
            echo "✅ ArgoCD will now automatically deploy the new version!"
        }
        failure {
            echo "❌ CD Pipeline failed — check logs!"
        }
    }
}